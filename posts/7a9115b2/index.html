

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.ico">
  <link rel="icon" href="/images/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="使用 Python 从串口读取 Arduino 发送的 JY61P 陀螺仪传感器和压力传感器的数据，这其中包含了数据的校验。">
  <meta name="author" content="Shieru">
  <meta name="keywords" content="">
  
  <title>Python 从 Arduino 获取 JY61P 及压力传感器数据 - Shieru</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/vs2015.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"jin-yuhan.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"#"},"progressbar":{"enable":false,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Shieru" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Shieru</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/bangumis/">
                <i class="iconfont icon-bilibili-fill"></i>
                番剧
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://travellings.now.sh">
                <i class="iconfont icon-map"></i>
                开往
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://cdn.jsdelivr.net/gh/Jin-Yuhan/WebAssetStorage@latest/img/python_logo.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Python 从 Arduino 获取 JY61P 及压力传感器数据">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Shieru
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-12-26 20:46" pubdate>
        2020年12月26日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      45
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Python 从 Arduino 获取 JY61P 及压力传感器数据</h1>
            
            <div class="markdown-body">
              <div class="note note-info">
            <p>本文中的非示例代码，均在我参与的研究性课题中使用，并由我完成编写。开发板为 Arduino UNO。本文内容具有一定的时效性，无法保证其在您阅读时依旧正确。</p>
          </div>
<h1 id="Arduino-部分"><a href="#Arduino-部分" class="headerlink" title="Arduino 部分"></a>Arduino 部分</h1><p>Arduino 部分的代码，主要实现了：</p>
<ul>
<li>读取与校验 JY61P 陀螺仪传感器的数据。</li>
<li>读取压力传感器的数据。</li>
<li>通过串口将数据发送至 Python。</li>
</ul>
<h2 id="JY61P-参数"><a href="#JY61P-参数" class="headerlink" title="JY61P 参数"></a>JY61P 参数</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">主要参数</th>
<th style="text-align:center">参数值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">使用芯片</td>
<td style="text-align:center">ICM-42605</td>
</tr>
<tr>
<td style="text-align:center">电压</td>
<td style="text-align:center">3.3-5V</td>
</tr>
<tr>
<td style="text-align:center">电流</td>
<td style="text-align:center">&lt;25mA</td>
</tr>
<tr>
<td style="text-align:center">通信方式</td>
<td style="text-align:center">串口TTL/IIC通信</td>
</tr>
<tr>
<td style="text-align:center">输出数据</td>
<td style="text-align:center">三轴（加速度+角速度+角度）+ 四元数</td>
</tr>
<tr>
<td style="text-align:center">陀螺仪范围</td>
<td style="text-align:center">±250/500/1000/2000°/s（可设置）</td>
</tr>
<tr>
<td style="text-align:center">加速度范围</td>
<td style="text-align:center">±2/4/8/16g（可设置）</td>
</tr>
<tr>
<td style="text-align:center">角度范围</td>
<td style="text-align:center">X/Z轴：±180°  Y轴：±90°</td>
</tr>
<tr>
<td style="text-align:center">角度精度</td>
<td style="text-align:center">静态：0.05°  动态：0.1°</td>
</tr>
<tr>
<td style="text-align:center">回传速度</td>
<td style="text-align:center">0.1-200Hz（可设置）</td>
</tr>
<tr>
<td style="text-align:center">波特率</td>
<td style="text-align:center">4800-921600（IIC速率达400K）</td>
</tr>
</tbody>
</table>
</div>
<h2 id="读取陀螺仪的数据"><a href="#读取陀螺仪的数据" class="headerlink" title="读取陀螺仪的数据"></a>读取陀螺仪的数据</h2><h3 id="数据协议"><a href="#数据协议" class="headerlink" title="数据协议"></a>数据协议</h3><p><strong>此部分内容也可以自行阅读《JY61P姿态角度传感器说明书》。</strong></p>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ol>
<li>数据是按照16进制方式发送的，不是 ASCII 码。</li>
<li>每个数据分低字节和高字节依次传送，二者组合成一个有符号的 <code>short</code> 类型的数据。</li>
</ol>
<h4 id="加速度"><a href="#加速度" class="headerlink" title="加速度"></a>加速度</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">数据编号</th>
<th style="text-align:center">数据内容</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0x55</td>
<td style="text-align:center">包头</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0x51</td>
<td style="text-align:center">加速度标识</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">AxL</td>
<td style="text-align:center">X分量低字节</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">AxH</td>
<td style="text-align:center">X分量高字节</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">AyL</td>
<td style="text-align:center">Y分量低字节</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">AyH</td>
<td style="text-align:center">Y分量高字节</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">AzL</td>
<td style="text-align:center">Z分量低字节</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">AzH</td>
<td style="text-align:center">Z分量高字节</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">TL</td>
<td style="text-align:center">温度低字节</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">TH</td>
<td style="text-align:center">温度高字节</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">SUM</td>
<td style="text-align:center">校验和</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// 加速度计算公式（g 为重力加速度；单位：米每二次方秒）</span><br><span class="hljs-keyword">double</span> a_x = (((<span class="hljs-keyword">short</span>)AxH &lt;&lt; <span class="hljs-number">8</span>) | AxL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">16</span> * g;<br><span class="hljs-keyword">double</span> a_y = (((<span class="hljs-keyword">short</span>)AyH &lt;&lt; <span class="hljs-number">8</span>) | AyL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">16</span> * g;<br><span class="hljs-keyword">double</span> a_z = (((<span class="hljs-keyword">short</span>)AzH &lt;&lt; <span class="hljs-number">8</span>) | AzL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">16</span> * g;<br><br><span class="hljs-comment">// 温度计算公式（单位：摄氏度）</span><br><span class="hljs-keyword">double</span> T = (((<span class="hljs-keyword">short</span>)TH &lt;&lt; <span class="hljs-number">8</span>) | TL) / <span class="hljs-number">100.0</span>;<br><br><span class="hljs-comment">// 校验和（如果下面的等式成立，则校验成功）</span><br>SUM == (<span class="hljs-number">0x55</span> + <span class="hljs-number">0x51</span> + AxL + AxH + AyL + AyH + AzL + AzH + TL + TH)<br></code></pre></div></td></tr></table></figure>
<h4 id="角速度"><a href="#角速度" class="headerlink" title="角速度"></a>角速度</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">数据编号</th>
<th style="text-align:center">数据内容</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0x55</td>
<td style="text-align:center">包头</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0x52</td>
<td style="text-align:center">角速度标识</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">WxL</td>
<td style="text-align:center">X分量低字节</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">WxH</td>
<td style="text-align:center">X分量高字节</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">WyL</td>
<td style="text-align:center">Y分量低字节</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">WyH</td>
<td style="text-align:center">Y分量高字节</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">WzL</td>
<td style="text-align:center">Z分量低字节</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">WzH</td>
<td style="text-align:center">Z分量高字节</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">TL</td>
<td style="text-align:center">温度低字节</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">TH</td>
<td style="text-align:center">温度高字节</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">SUM</td>
<td style="text-align:center">校验和</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// 角速度计算公式（单位：角度每秒）</span><br><span class="hljs-keyword">double</span> w_x = (((<span class="hljs-keyword">short</span>)WxH &lt;&lt; <span class="hljs-number">8</span>) | WxL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">2000</span>;<br><span class="hljs-keyword">double</span> w_y = (((<span class="hljs-keyword">short</span>)WyH &lt;&lt; <span class="hljs-number">8</span>) | WyL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">2000</span>;<br><span class="hljs-keyword">double</span> w_z = (((<span class="hljs-keyword">short</span>)WzH &lt;&lt; <span class="hljs-number">8</span>) | WzL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">2000</span>;<br><br><span class="hljs-comment">// 温度计算公式（单位：摄氏度）</span><br><span class="hljs-keyword">double</span> T = (((<span class="hljs-keyword">short</span>)TH &lt;&lt; <span class="hljs-number">8</span>) | TL) / <span class="hljs-number">100.0</span>;<br><br><span class="hljs-comment">// 校验和（如果下面的等式成立，则校验成功）</span><br>SUM == (<span class="hljs-number">0x55</span> + <span class="hljs-number">0x52</span> + WxL + WxH + WyL + WyH + WzL + WzH + TL + TH)<br></code></pre></div></td></tr></table></figure>
<h4 id="角度"><a href="#角度" class="headerlink" title="角度"></a>角度</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">数据编号</th>
<th style="text-align:center">数据内容</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0x55</td>
<td style="text-align:center">包头</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0x53</td>
<td style="text-align:center">角度标识</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">RollL</td>
<td style="text-align:center">X分量（滚转角）低字节</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">RollH</td>
<td style="text-align:center">X分量（滚转角）高字节</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">PitchL</td>
<td style="text-align:center">Y分量（俯仰角）低字节</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">PitchH</td>
<td style="text-align:center">Y分量（俯仰角）高字节</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">YawL</td>
<td style="text-align:center">Z分量（偏航角）低字节</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">YawH</td>
<td style="text-align:center">Z分量（偏航角）高字节</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">TL</td>
<td style="text-align:center">温度低字节</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">TH</td>
<td style="text-align:center">温度高字节</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">SUM</td>
<td style="text-align:center">校验和</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// 加速度计算公式（单位：角度）</span><br><span class="hljs-keyword">double</span> Roll = (((<span class="hljs-keyword">short</span>)RollH &lt;&lt; <span class="hljs-number">8</span>) | RollL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">180</span>;<br><span class="hljs-keyword">double</span> Pitch = (((<span class="hljs-keyword">short</span>)PitchH &lt;&lt; <span class="hljs-number">8</span>) | PitchL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">180</span>;<br><span class="hljs-keyword">double</span> Yaw = (((<span class="hljs-keyword">short</span>)YawH &lt;&lt; <span class="hljs-number">8</span>) | YawL) / <span class="hljs-number">32768.0</span> * <span class="hljs-number">180</span>;<br><br><span class="hljs-comment">// 温度计算公式（单位：摄氏度）</span><br><span class="hljs-keyword">double</span> T = (((<span class="hljs-keyword">short</span>)TH &lt;&lt; <span class="hljs-number">8</span>) | TL) / <span class="hljs-number">100.0</span>;<br><br><span class="hljs-comment">// 校验和（如果下面的等式成立，则校验成功）</span><br>SUM == (<span class="hljs-number">0x55</span> + <span class="hljs-number">0x53</span> + RollL + RollH + PitchL + PitchH + YawL + YawH + TL + TH)<br></code></pre></div></td></tr></table></figure>
<h3 id="辅助类型"><a href="#辅助类型" class="headerlink" title="辅助类型"></a>辅助类型</h3><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Vector3</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">short</span> X; <span class="hljs-comment">/* 向量的X分量 */</span><br>  <span class="hljs-keyword">short</span> Y; <span class="hljs-comment">/* 向量的Y分量 */</span><br>  <span class="hljs-keyword">short</span> Z; <span class="hljs-comment">/* 向量的Z分量 */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">GyroData</span></span><br><span class="hljs-class">&#123;</span><br>  Vector3 Acceleration;    <span class="hljs-comment">/* 加速度 */</span><br>  Vector3 AngularVelocity; <span class="hljs-comment">/* 角速度 */</span><br>  Vector3 Rotation;        <span class="hljs-comment">/* 旋转 */</span><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*GyroDataHandler)</span><span class="hljs-params">(GyroData data)</span></span>; <br></code></pre></div></td></tr></table></figure>
<h3 id="陀螺仪类"><a href="#陀螺仪类" class="headerlink" title="陀螺仪类"></a>陀螺仪类</h3><p>陀螺仪类实现了对陀螺仪数据的读取与校验。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RX数据缓冲区的长度</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RX_BUFFER_LEN 11</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gyro</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建一个陀螺仪传感器的实例</span><br><span class="hljs-comment">   */</span><br>  Gyro(<span class="hljs-keyword">void</span>);<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 更新陀螺仪数据</span><br><span class="hljs-comment">   * @param[in] ucData 从串口中读取的一个字节</span><br><span class="hljs-comment">   * @note 这个方法需要在loop函数中不断调用</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ucData)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置用来处理接收完成的陀螺仪数据的函数</span><br><span class="hljs-comment">   * @param[in] handler 陀螺仪数据的处理函数</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnFinishReceivingData</span><span class="hljs-params">(GyroDataHandler handler)</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>  GyroData dataCache;                      <span class="hljs-comment">/* 陀螺仪数据缓存 */</span><br>  GyroDataHandler dataHandler;             <span class="hljs-comment">/* 陀螺仪数据处理函数 */</span><br>  <span class="hljs-keyword">bool</span> isDataValid;                        <span class="hljs-comment">/* dataCache的数据是否合法 */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ucRxSum;                   <span class="hljs-comment">/* 从RX读取的字节的和 */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ucRxCount;                 <span class="hljs-comment">/* 从RX读取的字节数量 */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ucRxBuffer[RX_BUFFER_LEN]; <span class="hljs-comment">/* RX数据缓冲区 */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>
<p>实现陀螺仪类的构造方法，对字段进行初始化。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">Gyro::Gyro(<span class="hljs-keyword">void</span>)<br>&#123;<br>  <span class="hljs-keyword">this</span>-&gt;dataHandler = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">this</span>-&gt;isDataValid = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">this</span>-&gt;ucRxSum = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">this</span>-&gt;ucRxCount = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// memset(&amp;this-&gt;dataCache, 0, sizeof(GyroData));</span><br>  <span class="hljs-comment">// memset(this-&gt;ucRxBuffer, 0, sizeof(unsigned char) * RX_BUFFER_LEN);</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>实现核心方法 <code>Gyro::Update</code>，处理传入的一个字节的数据，根据协议，完成数据的读取和校验。</p>
<p>在三组数据读取完成后，如果数据全部校验成功，将会调用设置的回调，即 <code>dataHandler</code> 字段所指向的函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Gyro::Update</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ucData)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">this</span>-&gt;ucRxBuffer[<span class="hljs-keyword">this</span>-&gt;ucRxCount++] = ucData;<br><br>  <span class="hljs-keyword">if</span> (ucRxBuffer[<span class="hljs-number">0</span>] != <span class="hljs-number">0x55</span>)<br>  &#123;<br>    <span class="hljs-keyword">this</span>-&gt;ucRxCount = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;ucRxCount &lt; RX_BUFFER_LEN)<br>  &#123;<br>    <span class="hljs-keyword">this</span>-&gt;ucRxSum += ucData;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-comment">// 进入到该分支时，ucData是SUM的值，被写入了缓冲区的[10]</span><br>    <span class="hljs-keyword">bool</span> isValid = (<span class="hljs-keyword">this</span>-&gt;ucRxSum == ucData);<br><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>-&gt;ucRxBuffer[<span class="hljs-number">1</span>])<br>    &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x51</span>:<br>      <span class="hljs-keyword">this</span>-&gt;isDataValid &amp;= isValid;<br>      <span class="hljs-built_in">memcpy</span>(&amp;<span class="hljs-keyword">this</span>-&gt;dataCache.Acceleration, &amp;ucRxBuffer[<span class="hljs-number">2</span>], <span class="hljs-keyword">sizeof</span>(Vector3));<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x52</span>:<br>      <span class="hljs-keyword">this</span>-&gt;isDataValid &amp;= isValid;<br>      <span class="hljs-built_in">memcpy</span>(&amp;<span class="hljs-keyword">this</span>-&gt;dataCache.AngularVelocity, &amp;ucRxBuffer[<span class="hljs-number">2</span>], <span class="hljs-keyword">sizeof</span>(Vector3));<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x53</span>:<br>      <span class="hljs-built_in">memcpy</span>(&amp;<span class="hljs-keyword">this</span>-&gt;dataCache.Rotation, &amp;ucRxBuffer[<span class="hljs-number">2</span>], <span class="hljs-keyword">sizeof</span>(Vector3));<br><br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;dataHandler &amp;&amp; <span class="hljs-keyword">this</span>-&gt;isDataValid &amp;&amp; isValid)<br>      &#123;<br>        <span class="hljs-comment">// 为 dataCache 创建一个防御性副本</span><br>        <span class="hljs-keyword">this</span>-&gt;dataHandler(<span class="hljs-keyword">this</span>-&gt;dataCache); <span class="hljs-comment">// 触发事件</span><br>      &#125;<br><br>      <span class="hljs-keyword">this</span>-&gt;isDataValid = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;ucRxSum = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">this</span>-&gt;ucRxCount = <span class="hljs-number">0</span>;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>提供一个设置 <code>dataHandler</code> 字段的公共接口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Gyro::OnFinishReceivingData</span><span class="hljs-params">(GyroDataHandler handler)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">this</span>-&gt;dataHandler = handler;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="读取压力传感器数据"><a href="#读取压力传感器数据" class="headerlink" title="读取压力传感器数据"></a>读取压力传感器数据</h2><p>定义压力传感器类，根据我的需要，设置了6个压力传感器。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 压力传感器的数量</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PRESSURE_SENSOR_COUNT 6</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pressures</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建一组压力传感器的实例</span><br><span class="hljs-comment">   * @param[in] sensorPins 一个数组，保存所有连接了压力传感器的引脚的编号</span><br><span class="hljs-comment">   */</span><br>  Pressures(<span class="hljs-keyword">uint8_t</span> *sensorPins);<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 从压力传感器中读取数据</span><br><span class="hljs-comment">   * @param[in] buffer 保存数据的缓冲区，其长度应该与压力传感器的数量一致</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ReadData</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> *buffer)</span> <span class="hljs-keyword">const</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">uint8_t</span> sensorPins[PRESSURE_SENSOR_COUNT]; <span class="hljs-comment">/* 所有连接了压力传感器的引脚的编号 */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>
<p>实现构造方法，按顺序保存所有压力传感器使用的引脚编号。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">Pressures::Pressures(<span class="hljs-keyword">uint8_t</span> *sensorPins)<br>&#123;<br>  <span class="hljs-built_in">memcpy</span>(<span class="hljs-keyword">this</span>-&gt;sensorPins, sensorPins, PRESSURE_SENSOR_COUNT * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint8_t</span>));<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>提供读取数据的接口。遍历所有的引脚编号，读取模拟量并保存到缓冲区中。<br>将每一个压力传感器的值转换为16位无符号整数，可以在不丢失数据的前提下，方便后续在 Python 中读取。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Pressures::ReadData</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> *buffer)</span> <span class="hljs-keyword">const</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; PRESSURE_SENSOR_COUNT; i++)<br>  &#123;<br>    *buffer++ = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>)analogRead(<span class="hljs-keyword">this</span>-&gt;sensorPins[i]);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="定义-Python-数据包"><a href="#定义-Python-数据包" class="headerlink" title="定义 Python 数据包"></a>定义 Python 数据包</h2><p>发送给 Python 的数据包格式由标识数据、陀螺仪数据、压力传感器数据组成，其定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PyPackage</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> Flag0;                                <span class="hljs-comment">/* 第一个标识 */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> Flag1;                                <span class="hljs-comment">/* 第二个标识 */</span><br>  GyroData GyroData;                                  <span class="hljs-comment">/* 陀螺仪数据 */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> PressureData[PRESSURE_SENSOR_COUNT]; <span class="hljs-comment">/* 压力传感器数据 */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>
<p>我使用如下两个值来作为标识数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 数据包的第一个标识</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PACKAGE_FLAG_0 0x55</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 数据包的第二个标识</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PACKAGE_FLAG_1 0x59</span><br></code></pre></div></td></tr></table></figure>
<h2 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h2><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BAUDRATE 9600</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DELAY 0</span><br><br>Gyro *gyro;<br>Pressures *pressures;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendPackage</span><span class="hljs-params">(GyroData data)</span></span>;<br></code></pre></div></td></tr></table></figure>
<p>在 <code>setup</code> 函数中初始化，主要工作如下：</p>
<ol>
<li>初始化陀螺仪对象。</li>
<li>将 <code>SendPackage</code> 设置为陀螺仪数据接收成功的回调函数。</li>
<li>初始化压力传感器对象。</li>
<li>以特定的波特率初始化串口。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  gyro = <span class="hljs-keyword">new</span> Gyro();<br>  gyro-&gt;OnFinishReceivingData(SendPackage);<br><br>  <span class="hljs-keyword">uint8_t</span> sensors[PRESSURE_SENSOR_COUNT] = &#123;A0, A1, A2, A3, A4, A5&#125;;<br>  pressures = <span class="hljs-keyword">new</span> Pressures(sensors);<br><br>  Serial.begin(BAUDRATE);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>然后，在 <code>loop</code> 中更新陀螺仪的数据，再做适当的延迟。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">while</span> (Serial.available())<br>  &#123;<br>    gyro-&gt;Update(Serial.read());<br>  &#125;<br><br>  delay(DELAY);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>最后，实现 Python 数据包的发送。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendPackage</span><span class="hljs-params">(GyroData data)</span></span><br><span class="hljs-function"></span>&#123;<br>  PyPackage package;<br><br>  package.Flag0 = PACKAGE_FLAG_0;<br>  package.Flag1 = PACKAGE_FLAG_1;<br>  package.GyroData = data;<br>  pressures-&gt;ReadData(package.PressureData);<br><br>  Serial.write((<span class="hljs-keyword">char</span> *)&amp;package, <span class="hljs-keyword">sizeof</span>(PyPackage));<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>到这里，Arduino 部分已经完成！接下来就是在 Python 中接收数据。</p>
<h1 id="Python-部分"><a href="#Python-部分" class="headerlink" title="Python 部分"></a>Python 部分</h1><p>Python 部分的代码，主要实现了 Arduino 数据包的接收和解析。</p>
<h2 id="二进制流"><a href="#二进制流" class="headerlink" title="二进制流"></a>二进制流</h2><p>定义 <code>CStream</code> 类，从字节数组中解析数据。</p>
<h3 id="声明基本方法"><a href="#声明基本方法" class="headerlink" title="声明基本方法"></a>声明基本方法</h3><p>声明 <code>__init__</code> 和 <code>__len__</code> 方法。<br><code>__init__</code> 方法接受一个字节序列 <code>cbytes</code> 作为参数，后续的解析将基于这个序列中的数据来进行。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CStream</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, cbytes: <span class="hljs-built_in">bytes</span></span>):</span><br>    self.__cbytes = cbytes<br>    self.__index = <span class="hljs-number">0</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__len__</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.__cbytes)<br></code></pre></div></td></tr></table></figure>
<p>根据之前在 Arduino 中编写的代码，我们知道：数据包包体（不包括前两个标识字节）中的每一个数（包括向量的每一个分量）都由两个字节组成，而且使用<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Little-Endian/4118225?fr=aladdin">小字节序（Little-Endian）</a>。</p>
<p>因此，我们声明一个方法，从字节序列中向后读取两个字节，并按低位字节和高位字节的顺序返回。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__readTwoBytes</span>(<span class="hljs-params">self</span>):</span><br>  low = self.__cbytes[self.__index]<br>  high = self.__cbytes[self.__index + <span class="hljs-number">1</span>]<br>  self.__index += <span class="hljs-number">2</span><br>  <span class="hljs-keyword">return</span> low, high<br></code></pre></div></td></tr></table></figure>
<h3 id="读取整数"><a href="#读取整数" class="headerlink" title="读取整数"></a>读取整数</h3><p>首先，读取整数的低位字节和高位字节，分别记为 <code>low</code> 和 <code>high</code>。</p>
<blockquote>
<p>因为从 Arduino 发送的整数都由两个字节组成，而 Python 的 <code>int</code> 类型占用的字节数大于2，所以当整数有符号时， <code>(high &lt;&lt; 8) | low</code> 运算会将它的符号位当做数值位处理，导致结果不一定是正确的。</p>
</blockquote>
<p>读取有符号整数时，先忽略高位字节中的符号位，进行移位运算：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">v = ((high &amp; <span class="hljs-number">0x7F</span>) &lt;&lt; <span class="hljs-number">8</span>) | low<br></code></pre></div></td></tr></table></figure>
<p>对原始数据的符号做判断：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">sign = ((high &gt;&gt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">0x1</span>)<br><span class="hljs-comment"># sign == 0 表示正数</span><br><span class="hljs-comment"># sign == 1 表示负数</span><br></code></pre></div></td></tr></table></figure>
<p>如果是负数的话，还需要额外的运算。负数的储存形式是：相应正数按位取反再加1。使用它的逆运算就可以得到原始数值：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">-((~(v - <span class="hljs-number">1</span>)) &amp; <span class="hljs-number">0x7FFF</span>)<br></code></pre></div></td></tr></table></figure>
<p>读取无符号整数时，直接进行移位运算即可。</p>
<p>最后，整理成一个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">readInt</span>(<span class="hljs-params">self, signed=<span class="hljs-literal">True</span></span>):</span><br>  low, high = self.__readTwoBytes()<br><br>  <span class="hljs-keyword">if</span> signed:<br>    v = ((high &amp; <span class="hljs-number">0x7F</span>) &lt;&lt; <span class="hljs-number">8</span>) | low<br>    <span class="hljs-keyword">return</span> v <span class="hljs-keyword">if</span> (high &amp; <span class="hljs-number">0x80</span>) == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> -((~(v - <span class="hljs-number">1</span>)) &amp; <span class="hljs-number">0x7FFF</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> (high &lt;&lt; <span class="hljs-number">8</span>) | low<br></code></pre></div></td></tr></table></figure>
<p>注：有符号整数的读取也可以使用 <code>ctypes</code> 模块中的类来完成。</p>
<h3 id="读取浮点数"><a href="#读取浮点数" class="headerlink" title="读取浮点数"></a>读取浮点数</h3><p>从数据协议中可以发现：绝大部分的整数都会除以32768（2的15次方，即16位有符号整数的最大值）然后转换为浮点数，再进行其他运算。故可以封装一个方法来完成这步操作。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">readFloat</span>(<span class="hljs-params">self</span>):</span><br>  <span class="hljs-keyword">return</span> self.readInt(signed=<span class="hljs-literal">True</span>) / <span class="hljs-number">32768.0</span><br></code></pre></div></td></tr></table></figure>
<h3 id="读取向量"><a href="#读取向量" class="headerlink" title="读取向量"></a>读取向量</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">readIntVec</span>(<span class="hljs-params">self, elementDecorator, dimension=<span class="hljs-number">3</span>, signed=<span class="hljs-literal">True</span></span>):</span><br>  <span class="hljs-keyword">return</span> [<br>    elementDecorator(i, self.readInt(signed=signed))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(dimension)<br>  ]<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">readFloatVec</span>(<span class="hljs-params">self, elementDecorator, dimension=<span class="hljs-number">3</span></span>):</span><br>  <span class="hljs-keyword">return</span> [<br>    elementDecorator(i, self.readFloat())<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(dimension)<br>  ]<br></code></pre></div></td></tr></table></figure>
<h2 id="定义数据包"><a href="#定义数据包" class="headerlink" title="定义数据包"></a>定义数据包</h2><p>根据 Arduino 端的代码来进行定义。因为标识数据只是在接收数据包时使用的，所以不需要增加这个字段。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArduinoPackage</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, acceleration, angularVelocity, rotation, leftPressures, rightPressures</span>):</span><br>    self.acceleration = acceleration<br>    self.angularVelocity = angularVelocity<br>    self.rotation = rotation<br>    self.leftPressures = leftPressures<br>    self.rightPressures = rightPressures<br></code></pre></div></td></tr></table></figure>
<h2 id="接收数据包"><a href="#接收数据包" class="headerlink" title="接收数据包"></a>接收数据包</h2><p>定义 <code>ArduinoReader</code> 类，从串口中接收数据包。</p>
<h3 id="声明基本方法-1"><a href="#声明基本方法-1" class="headerlink" title="声明基本方法"></a>声明基本方法</h3><p>对字段做初始化，并提供上下文管理器和一些公共方法。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> serial <span class="hljs-keyword">import</span> Serial <span class="hljs-comment"># 需要安装 pyserial 模块</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArduinoReader</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, **kwargs</span>):</span><br>    port = kwargs.get(<span class="hljs-string">&#x27;port&#x27;</span>, <span class="hljs-literal">None</span>)<br>    baudrate = kwargs.get(<span class="hljs-string">&#x27;baudrate&#x27;</span>, <span class="hljs-number">9600</span>)<br>    timeout = kwargs.get(<span class="hljs-string">&#x27;timeout&#x27;</span>, <span class="hljs-number">1</span>)<br>    <br>    self.__serial = Serial(port=port, baudrate=baudrate, timeout=timeout)<br>    self.gravity = kwargs.get(<span class="hljs-string">&#x27;gravity&#x27;</span>, <span class="hljs-number">9.8</span>)<br>    self.packageFlag0 = kwargs.get(<span class="hljs-string">&#x27;packageFlag0&#x27;</span>, <span class="hljs-number">0x55</span>)<br>    self.packageFlag1 = kwargs.get(<span class="hljs-string">&#x27;packageFlag1&#x27;</span>, <span class="hljs-number">0x59</span>)<br>    self.packageBodySize = kwargs.get(<span class="hljs-string">&#x27;packageBodySize&#x27;</span>, <span class="hljs-number">30</span>)<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open</span>(<span class="hljs-params">self</span>):</span><br>    self.__serial.<span class="hljs-built_in">open</span>()<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close</span>(<span class="hljs-params">self</span>):</span><br>    self.__serial.close()<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__enter__</span>(<span class="hljs-params">self</span>):</span><br>    self.__serial.__enter__()<br>    <span class="hljs-keyword">return</span> self<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__exit__</span>(<span class="hljs-params">self, extype, value, trace</span>):</span><br>    self.__serial.__exit__(extype, value, trace)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">canRead</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-keyword">return</span> self.__serial.is_open<br></code></pre></div></td></tr></table></figure>
<h3 id="检验标识数据"><a href="#检验标识数据" class="headerlink" title="检验标识数据"></a>检验标识数据</h3><p>阻塞当前线程，不断从串口中读取两个字节，与预设的标识字节做比较，相等时从方法中返回，准备读取包体。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__readSingleByte</span>(<span class="hljs-params">self</span>):</span><br>  data = self.__serial.read(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">return</span> data[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__checkPackageFlags</span>(<span class="hljs-params">self</span>):</span><br>  previous = self.__readSingleByte()<br><br>  <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    current = self.__readSingleByte()<br>    <span class="hljs-comment"># 前面两个字节是标识位</span><br>    <span class="hljs-keyword">if</span> previous == self.packageFlag0 <span class="hljs-keyword">and</span> current == self.packageFlag1:<br>      <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">else</span>:<br>      previous = current<br></code></pre></div></td></tr></table></figure>
<h3 id="解析为-Python-对象"><a href="#解析为-Python-对象" class="headerlink" title="解析为 Python 对象"></a>解析为 Python 对象</h3><p>从串口中读取一定数量的字节，利用 <code>CStream</code> 解析字节序列中的内容，最后创建一个 <code>ArduinoPackage</code> 对象并返回。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__makePackage</span>(<span class="hljs-params">self, cbytes</span>):</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(cbytes) != self.packageBodySize:<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>  stream = CStream(cbytes)<br><br>  accel = stream.readFloatVec(<span class="hljs-keyword">lambda</span> i, v: <span class="hljs-built_in">round</span>(v * <span class="hljs-number">16</span> * self.gravity, <span class="hljs-number">4</span>))<br>  angularV = stream.readFloatVec(<span class="hljs-keyword">lambda</span> i, v: <span class="hljs-built_in">round</span>(v * <span class="hljs-number">2000</span>, <span class="hljs-number">4</span>))<br>  rotation = stream.readFloatVec(<span class="hljs-keyword">lambda</span> i, v: <span class="hljs-built_in">round</span>(v * <span class="hljs-number">180</span>, <span class="hljs-number">4</span>))<br>  <br>  left = stream.readIntVec(<span class="hljs-keyword">lambda</span> i, v: (v), signed=<span class="hljs-literal">False</span>)<br>  right = stream.readIntVec(<span class="hljs-keyword">lambda</span> i, v: (v), signed=<span class="hljs-literal">False</span>)<br><br>  <span class="hljs-keyword">return</span> ArduinoPackage(accel, angularV, rotation, left, right)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span>(<span class="hljs-params">self</span>):</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.canRead:<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>  self.__checkPackageFlags()<br>  cbytes = self.__serial.read(self.packageBodySize)<br>  <span class="hljs-keyword">return</span> self.__makePackage(cbytes)<br></code></pre></div></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> arduino_reader <span class="hljs-keyword">import</span> ArduinoReader<br><br>arduinoConfig = &#123;<br>  <span class="hljs-string">&quot;port&quot;</span>: <span class="hljs-string">&quot;COM6&quot;</span>,<br>  <span class="hljs-string">&quot;baudrate&quot;</span>: <span class="hljs-number">9600</span>,<br>  <span class="hljs-string">&quot;timeout&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;gravity&quot;</span>: <span class="hljs-number">9.8</span>,<br>  <span class="hljs-string">&quot;packageFlag0&quot;</span>: <span class="hljs-number">0x55</span>,<br>  <span class="hljs-string">&quot;packageFlag1&quot;</span>: <span class="hljs-number">0x59</span>,<br>  <span class="hljs-string">&quot;packageBodySize&quot;</span>: <span class="hljs-number">30</span><br>&#125;<br><br><span class="hljs-keyword">with</span> ArduinoReader(**arduinoConfig) <span class="hljs-keyword">as</span> reader:<br>  <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    package = reader.read()<br>    <span class="hljs-comment"># ...</span><br></code></pre></div></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/">嵌入式开发</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/C-C/">C/C++</a>
                    
                      <a class="hover-with-bg" href="/tags/Python/">Python</a>
                    
                      <a class="hover-with-bg" href="/tags/Arduino/">Arduino</a>
                    
                      <a class="hover-with-bg" href="/tags/JY61P/">JY61P</a>
                    
                      <a class="hover-with-bg" href="/tags/%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1/">串口通信</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/1e958f7/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Python 利用 ctypes 调用 C 库函数</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/3d688237/">
                        <span class="hidden-mobile">使用 VSCode 开发 Arduino</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "HI2Js1k39RFt8RHuCG8e5VjN-gzGzoHsz",
          app_key: "LcfwljEHCBJDszwBSjQX8Msc",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: false,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
       <div style="text-align:center;"> <span>如果您愿意请我喝一杯咖啡的话，可以使用微信扫描下方的二维码。</span> <img src="/images/wechatpay.jpg" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:200px; height:200px;"> </div> 
    </div>
  </div>


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> Theme <a target="_blank" rel="noopener" href="https://github.com/fluid-dev/hexo-theme-fluid">Fluid</a><br> ©2020-2021 Shieru 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  

<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<!-- hexo injector body_end start -->
    <div id="arknights-live2d">
        <audio><source></source></audio>
    </div>
    <script src="https://cdn.jsdelivr.net/gh/Jin-Yuhan/WebAssetStorage@latest/js/spine-widget.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Jin-Yuhan/WebAssetStorage@latest/js/spine-skeleton-binary3.5.51.js"></script>
    <script src="/js/arknights_live2d.js"></script>
    <script>
        new ArknightsLive2D({
            urlPrefix: "https://cdn.jsdelivr.net/gh/Jin-Yuhan/WebAssetStorage@latest/live2d/char_1012_skadi2/",
            style: {"width":"200px","height":"200px","position":"fixed","left":"0","bottom":"0","z-Index":"999"},
            skin: "default",
            atlas: "char_1012_skadi2.atlas",
            skeleton: "char_1012_skadi2.skel",
            behaviors: {"start":{"animation":"Start","voice":"audios/CN_042.mp3"},"idle":{"animation":"Idle","voice":"audios/CN_010.mp3","maxMinutes":5},"interact":{"animations":[{"name":"Skill_2_Begin","loop":false},{"name":"Skill_2_Loop","loop":true}],"voices":["audios/CN_002.mp3","audios/CN_003.mp3","audios/CN_004.mp3","audios/CN_005.mp3","audios/CN_006.mp3","audios/CN_007.mp3","audios/CN_008.mp3","audios/CN_009.mp3","audios/CN_034.mp3","audios/CN_036.mp3"]}}
        }).preload();
    </script>
    <!-- hexo injector body_end end --></body>
</html>
